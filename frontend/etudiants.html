<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AcademiX | Gestion Étudiants</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar { background: #2c3e50; margin-bottom: 30px; }
        .navbar-brand, .nav-link { color: white !important; }
        .card { border: none; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn-add { background-color: #27ae60; color: white; border: none; font-weight: 600; padding: 10px 20px; }
        .btn-add:hover { background-color: #219150; color: white; }
        .table-dark { background-color: #34495e !important; }

        /* Couleur identique à la navbar (#2c3e50) */
.footer-custom {
    background-color: #2c3e50;
    border-top: 3px solid #f39c12; /* Petit trait orange comme le menu actif */
}

/* Force le footer à rester en bas si la liste est courte */
html, body {
    height: 100%;
}
body {
    display: flex;
    flex-direction: column;
}
.container {
    flex: 1 0 auto;
}
footer {
    flex-shrink: 0;
}
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#"><i class="fas fa-university"></i> AcademiX</a>
            <div class="navbar-nav ms-auto">
    <a class="nav-link" href="formations.html">Formations</a>
    <a class="nav-link active fw-bold text-warning" href="etudiants.html">Étudiants</a>
    <a class="nav-link" href="inscriptions.html">Inscriptions</a>
</div>
        </div>
    </nav>

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold text-secondary">Liste des Étudiants</h2>
            <button class="btn btn-add shadow-sm" data-bs-toggle="modal" data-bs-target="#studentModal" onclick="prepareAdd()">
                <i class="fas fa-plus-circle"></i> Ajouter un étudiant
            </button>
        </div>

        <div class="stats-card">
   <h3>Nombre total d'étudiants : <span id="student-count">0</span></h3>
</div>

<div style="margin-bottom: 20px;">
    <input type="text" id="searchBar" onkeyup="doSearch()" placeholder="Taper un nom pour chercher..." 
           style="padding: 8px; width: 300px; border: 1px solid #ccc; border-radius: 4px;">
</div>

        <div class="card p-3">
            <div class="table-responsive">
                <table class="table table-hover align-middle" id="studentsTable">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Email</th>
                            <th>Prénom</th>
                            <th>Nom</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="studentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title fw-bold" id="formTitle">Nouvel Étudiant</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="studentForm">
                    <div class="modal-body p-4">
                        <input type="hidden" id="studentId">
                        <div class="mb-3">
                            <label class="form-label fw-bold small">EMAIL</label>
                            <input type="email" class="form-control" id="email" placeholder="exemple@univ.fr" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small">PRÉNOM</label>
                            <input type="text" class="form-control" id="firstName" placeholder="Jean" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small">NOM</label>
                            <input type="text" class="form-control" id="lastName" placeholder="Dupont" required>
                        </div>
                    </div>
                    <div class="modal-footer border-0">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-success px-4" id="submitBtn">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const apiUrl = "http://localhost:8081/students";
        const studentModal = new bootstrap.Modal(document.getElementById('studentModal'));

        // FONCTION AJOUTÉE POUR NE PAS CASSER DOSEARCH
        function remplirTableau(students) {
            const tbody = document.querySelector("#studentsTable tbody");
            tbody.innerHTML = "";
            students.forEach(student => {
                tbody.innerHTML += `
                    <tr>
                        <td class="fw-bold">#${student.id}</td>
                        <td>${student.email}</td>
                        <td>${student.firstName}</td>
                        <td>${student.lastName}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-warning me-2" onclick="editStudent(${student.id})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteStudent(${student.id})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
            // Met à jour le compteur
            document.getElementById('student-count').innerText = students.length;
        }

        async function loadStudents() {
            try {
                const res = await fetch(apiUrl);
                const students = await res.json();
                // On utilise la nouvelle fonction ici aussi pour être cohérent
                remplirTableau(students);
            } catch (e) { console.error("Erreur de chargement", e); }
        }

        document.getElementById("studentForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const id = document.getElementById("studentId").value;
            const studentData = {
                email: document.getElementById("email").value,
                firstName: document.getElementById("firstName").value,
                lastName: document.getElementById("lastName").value
            };

            const method = id ? "PUT" : "POST";
            const url = id ? `${apiUrl}/${id}` : apiUrl;

            await fetch(url, {
                method: method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(studentData)
            });

            studentModal.hide();
            resetForm();
            loadStudents();
        });

        async function deleteStudent(id) {
            if (confirm("Supprimer cet étudiant ?")) {
                await fetch(`${apiUrl}/${id}`, { method: "DELETE" });
                loadStudents();
            }
        }

        async function editStudent(id) {
            const res = await fetch(`${apiUrl}/${id}`);
            const student = await res.json();
            document.getElementById("studentId").value = student.id;
            document.getElementById("email").value = student.email;
            document.getElementById("firstName").value = student.firstName;
            document.getElementById("lastName").value = student.lastName;
            document.getElementById("formTitle").textContent = "Modifier l'étudiant";
            document.getElementById("submitBtn").textContent = "Modifier";
            studentModal.show();
        }

        function prepareAdd() {
            resetForm();
            document.getElementById("formTitle").textContent = "Ajouter un étudiant";
            document.getElementById("submitBtn").textContent = "Ajouter";
        }

        function resetForm() {
            document.getElementById("studentForm").reset();
            document.getElementById("studentId").value = "";
        }

        // Lancement initial
        loadStudents();

        function doSearch() {
            const motCle = document.getElementById('searchBar').value;
            const url = motCle === "" 
                ? apiUrl 
                : `${apiUrl}/search?keyword=${motCle}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    // Maintenant cette fonction existe !
                    remplirTableau(data); 
                })
                .catch(error => console.error("Erreur de recherche:", error));
        }        
    </script>
    <footer class="footer-custom text-white text-center py-4 mt-5">
    <div class="container">
        <p class="mb-0 fw-bold">Plateforme de gestion des inscriptions académiques</p>
        <small class="opacity-75">© 2026 AcademiX </small>
    </div>
</footer>
</body>
</html>